<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çç è›‡ï¼šéŸ³ä¹ç»ˆæä¿®å¤</title>
    <style>
        :root { --blue: #007aff; --red: #ff3b30; --bg: #ffffff; }
        body {
            margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center;
            background-color: var(--bg); color: #1d1d1f; font-family: -apple-system, sans-serif;
            overflow: hidden; touch-action: none; height: 100vh;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .warning-text { color: var(--red) !important; animation: pulse 0.5s infinite; }
        .overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 30px; text-align: center;
        }
        .guide-box {
            background: #f2f2f7; padding: 18px; border-radius: 15px; max-width: 300px;
            margin: 15px 0; font-size: 13px; line-height: 1.6; color: #444; text-align: left;
            border: 1px solid #e5e5ea;
        }
        .action-btn { background: black; color: white; border: none; padding: 16px 45px; border-radius: 35px; font-size: 18px; font-weight: bold; cursor: pointer; }
        #top-ui { width: 100%; position: absolute; top: 10px; display: flex; flex-direction: column; align-items: center; z-index: 10; pointer-events: none; }
        .timer-row { display: flex; gap: 10px; }
        .timer-box { background: rgba(255,255,255,0.95); padding: 5px 12px; border-radius: 8px; border: 1px solid #eee; font-size: 11px; font-weight: bold; }
        .status-tag { padding: 2px 10px; border-radius: 4px; font-size: 11px; font-weight: 900; color: white; margin-top: 5px; }
        #score-board { font-size: 64px; font-weight: 900; margin-top: 80px; color: #000; letter-spacing: -3px; }
        #game-container { position: relative; border-radius: 15px; box-shadow: 0 15px 50px rgba(0,0,0,0.12); background: #fff; overflow: hidden; }
        canvas { display: block; width: 88vw; height: 88vw; max-width: 380px; max-height: 380px; }
        #controls { position: fixed; bottom: 30px; width: 100%; display: flex; justify-content: space-around; align-items: center; pointer-events: auto; }
        .d-pad { display: grid; grid-template-columns: repeat(3, 72px); grid-template-rows: repeat(3, 72px); }
        .d-btn { width: 72px; height: 72px; background: #f2f2f7; border: 1px solid #e5e5ea; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        #boost-btn { width: 100px; height: 100px; background: black; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 6px solid white; color: white; font-weight: bold; box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="start-screen" class="overlay">
        <h1 style="font-size: 32px; margin:0;">çç è›‡</h1>
        <p style="color: var(--red); font-weight: 900; margin-top:5px;">STRANGER SYSTEMS</p>
        <div class="guide-box">
            <div style="margin-bottom:8px;">ğŸŸ¡ <b>é£Ÿç‰© (x4)</b> | âšª <b>æ­£é¢çƒ (x4)</b></div>
            <div style="margin-bottom:8px;">ğŸ”´ <b>è´Ÿé¢çƒ (x3)</b> | ğŸ”µ <b>ä¼ é€é—¨ (å³æ—¶)</b></div>
        </div>
        <button id="start-btn" class="action-btn">å¯åŠ¨ç³»ç»Ÿ</button>
    </div>

    <div id="death-screen" class="overlay" style="display: none;">
        <h2 style="font-size: 40px; margin:0;">åŒæ­¥ä¸¢å¤±</h2>
        <p id="death-quote" style="margin:20px 0; color:var(--red);">æ•°æ®é‡è¿ä¸­...</p>
        <button id="restart-btn" class="action-btn">é‡æ–°åŒæ­¥</button>
    </div>

    <div id="top-ui">
        <div class="timer-row">
            <div id="box-obs" class="timer-box">åœ°å½¢é‡ç»„: <span id="t-obs">10.0</span>s</div>
            <div id="box-portal" class="timer-box">ä¼ é€å˜ç›¸: <span id="t-portal">20.0</span>s</div>
        </div>
        <div id="status-overlay" style="display: flex; gap:5px;">
            <div id="tag-shield" class="status-tag" style="background: var(--blue); display:none;">ğŸ›¡ï¸ æŠ¤ç›¾</div>
            <div id="tag-confused" class="status-tag" style="background: var(--red); display:none;">âš ï¸ é€†è½¬</div>
        </div>
    </div>

    <div id="score-board">0</div>
    <div id="game-container"><canvas id="gameCanvas" width="2048" height="2048"></canvas></div>

    <div id="controls">
        <div class="d-pad">
            <div id="btn-up" class="d-btn" style="grid-area: 1/2;">â–²</div>
            <div id="btn-left" class="d-btn" style="grid-area: 2/1;">â—€</div>
            <div id="btn-right" class="d-btn" style="grid-area: 2/3;">â–¶</div>
            <div id="btn-down" class="d-btn" style="grid-area: 3/2;">â–¼</div>
        </div>
        <button id="boost-btn">åŠ é€Ÿ</button>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d', { alpha: false });
    const tileCount = 32, res = 2048, size = res / tileCount;
    
    let score = 0, dx = 0, dy = -1, isPaused = true;
    let snake = [], foods = [], obstacles = [], portals = [], skills = [];
    let timers = { obs: 10, portal: 20 }, state = { shield: false, confusedCD: 0 };
    let isBoosting = false, lastTime = 0, lastTimestamp = 0;
    
    // --- éŸ³é¢‘å¼•æ“æ ¸å¿ƒä¿®å¤ ---
    let audioCtx = null;
    let nextBeatTime = 0;
    let isMusicActive = false; // ç‹¬ç«‹éŸ³ä¹å¼€å…³
    const notes = [130.81, 146.83, 164.81, 174.61, 196.00, 174.61, 164.81, 146.83];
    let noteIndex = 0;

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') audioCtx.resume();
        nextBeatTime = audioCtx.currentTime + 0.1;
        isMusicActive = true;
    }

    function musicScheduler() {
        if (!isMusicActive || !audioCtx) return;

        // å¦‚æœæ¸¸æˆæš‚åœï¼Œæˆ‘ä»¬ä¾ç„¶è¿è¡Œè°ƒåº¦å™¨ï¼Œä½†è·³è¿‡èŠ‚æ‹æ’­æ”¾ï¼Œæˆ–è€…ä¿æŒææ…¢èŠ‚å¥
        // å…³é”®ä¿®å¤ï¼šå¦‚æœ nextBeatTime è½åå¤ªå¤šï¼Œç«‹å³å¯¹é½
        if (nextBeatTime < audioCtx.currentTime) {
            nextBeatTime = audioCtx.currentTime + 0.05;
        }

        while (nextBeatTime < audioCtx.currentTime + 0.1) {
            if (!isPaused) {
                playStep(nextBeatTime);
            }
            const tempo = (isBoosting ? 0.12 : 0.24) / (1 + score * 0.01);
            nextBeatTime += tempo;
        }
        setTimeout(musicScheduler, 25);
    }

    function playStep(time) {
        // Kick
        const osc1 = audioCtx.createOscillator();
        const g1 = audioCtx.createGain();
        osc1.frequency.setValueAtTime(isBoosting ? 80 : 60, time);
        osc1.frequency.exponentialRampToValueAtTime(0.01, time + 0.1);
        g1.gain.setValueAtTime(0.4, time);
        g1.gain.exponentialRampToValueAtTime(0.01, time + 0.1);
        osc1.connect(g1); g1.connect(audioCtx.destination);
        osc1.start(time); osc1.stop(time + 0.1);

        // Bass/Melody
        const osc2 = audioCtx.createOscillator();
        const g2 = audioCtx.createGain();
        osc2.type = 'sawtooth';
        osc2.frequency.setValueAtTime(notes[noteIndex % notes.length], time);
        g2.gain.setValueAtTime(0.04, time);
        g2.gain.exponentialRampToValueAtTime(0.001, time + 0.15);
        osc2.connect(g2); g2.connect(audioCtx.destination);
        osc2.start(time); osc2.stop(time + 0.15);
        noteIndex++;
    }

    function playSfx(freq, type='sine', dur=0.2) {
        if(!audioCtx || audioCtx.state === 'suspended') return;
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.type = type; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
        g.gain.setValueAtTime(0.1, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + dur);
    }

    // --- æ¸¸æˆæ ¸å¿ƒ ---
    function gameReset() {
        score = 0; dx = 0; dy = -1;
        snake = [{x: 16, y: 16}, {x: 16, y: 17}, {x: 16, y: 18}];
        foods = []; skills = [];
        timers = { obs: 10, portal: 20 };
        state = { shield: false, confusedCD: 0 };
        document.getElementById('score-board').innerText = "0";
        obstacles = Array(12).fill(0).map(() => getSafePos());
        portals = [getSafePos(), getSafePos()]; // å¼€å±€å³ç”Ÿæˆ
        spawnItems();
    }

    function getSafePos() {
        for(let i=0; i<100; i++) {
            let p = {x: Math.floor(Math.random()*tileCount), y: Math.floor(Math.random()*tileCount)};
            if ([...snake, ...obstacles, ...portals, ...skills, ...foods].every(it => it.x !== p.x || it.y !== p.y)) return p;
        }
        return {x: -1, y: -1};
    }

    function spawnItems() {
        while(foods.length < 4) { 
            let p = getSafePos(); if(p.x===-1) break;
            const r = Math.random(); foods.push({...p, n: r>0.8?'ğŸ”':(r>0.5?'ğŸŸ':'ğŸ'), v: r>0.8?5:(r>0.5?3:1)});
        }
        while(skills.filter(s => s.type === 'good').length < 4) {
            let p = getSafePos(); if(p.x!==-1) skills.push({...p, type: 'good'}); else break;
        }
        while(skills.filter(s => s.type === 'bad').length < 3) {
            let p = getSafePos(); if(p.x!==-1) skills.push({...p, type: 'bad'}); else break;
        }
    }

    function update() {
        if (isPaused) return;
        let nx = (snake[0].x + dx + tileCount) % tileCount;
        let ny = (snake[0].y + dy + tileCount) % tileCount;

        if (obstacles.some(o => o.x === nx && o.y === ny)) {
            if(state.shield) { state.shield = false; obstacles = obstacles.filter(o=>o.x!==nx||o.y!==ny); playSfx(400, 'square'); }
            else return die();
        }
        if (snake.some(s => s.x === nx && s.y === ny)) return die();

        for (let p of portals) { if (nx === p.x && ny === p.y) { const othr = portals.find(o => o !== p); if(othr) { nx = othr.x; ny = othr.y; playSfx(880); } break; } }

        const fIdx = foods.findIndex(f => f.x === nx && f.y === ny);
        if (fIdx !== -1) {
            score += foods[fIdx].v; document.getElementById('score-board').innerText = score;
            playSfx(900 + (score*5)); foods.splice(fIdx, 1); snake.unshift({x: nx, y: ny});
        } else {
            const sIdx = skills.findIndex(s => s.x === nx && s.y === ny);
            if(sIdx !== -1) {
                if(skills[sIdx].type === 'good') { if(Math.random()>0.5) state.shield=true; else obstacles=[]; playSfx(1100); }
                else { state.confusedCD=5; playSfx(150, 'sawtooth'); }
                skills.splice(sIdx, 1);
            }
            snake.unshift({x: nx, y: ny}); snake.pop();
        }
        spawnItems();
    }

    function die() {
        isPaused = true;
        document.getElementById('death-screen').style.display = 'flex';
        playSfx(80, 'sawtooth', 0.4);
    }

    function loop(t) {
        if(!lastTimestamp) lastTimestamp = t;
        const dt = (t - lastTimestamp) / 1000;
        lastTimestamp = t;
        if(!isPaused) {
            timers.obs -= dt; timers.portal -= dt;
            state.confusedCD = Math.max(0, state.confusedCD - dt);
            document.getElementById('t-obs').innerText = Math.max(0, timers.obs).toFixed(1);
            document.getElementById('t-portal').innerText = Math.max(0, timers.portal).toFixed(1);
            document.getElementById('tag-shield').style.display = state.shield ? 'block' : 'none';
            document.getElementById('tag-confused').style.display = state.confusedCD > 0 ? 'block' : 'none';
            if(timers.obs <= 0) { obstacles = Array(12).fill(0).map(()=>getSafePos()); timers.obs = 10; playSfx(200, 'square'); }
            if(timers.portal <= 0) { portals = [getSafePos(), getSafePos()]; timers.portal = 20; }
        }
        let speed = (isBoosting ? 60 : 150) * Math.pow(0.98, Math.floor(score/10));
        if(t - lastTime > speed) { update(); lastTime = t; }
        
        // æ¸²æŸ“é€»è¾‘
        ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, res, res);
        obstacles.forEach(o => { ctx.fillStyle = timers.obs < 2.5 ? (Math.sin(t*0.01)>0?'#ff3b30':'#444') : '#444'; ctx.beginPath(); ctx.roundRect(o.x*size+10, o.y*size+10, size-20, size-20, 15); ctx.fill(); });
        portals.forEach(p => { ctx.strokeStyle = '#007aff'; ctx.lineWidth = 15; ctx.beginPath(); ctx.arc(p.x*size+size/2, p.y*size+size/2, size*0.4, 0, 7); ctx.stroke(); });
        skills.forEach(s => { ctx.strokeStyle = s.type === 'good' ? '#8e8e93' : '#ff3b30'; ctx.lineWidth = 12; ctx.beginPath(); ctx.arc(s.x*size+size/2, s.y*size+size/2, size*0.35, 0, 7); ctx.stroke(); });
        foods.forEach(f => { ctx.font="45px Arial"; ctx.textAlign="center"; ctx.fillText(f.n, f.x*size+size/2, f.y*size+size/2+15); });
        snake.forEach((s, i) => { ctx.fillStyle = i===0?(state.confusedCD>0?'#ff3b30':'#007aff'):'#000'; ctx.beginPath(); ctx.arc(s.x*size+size/2, s.y*size+size/2, size*0.4, 0, 7); ctx.fill(); });
        
        requestAnimationFrame(loop);
    }

    // --- æŒ‰é’®é€»è¾‘ ---
    document.getElementById('start-btn').onclick = () => {
        document.getElementById('start-screen').style.display = 'none';
        initAudio();
        gameReset();
        isPaused = false;
        musicScheduler();
    };

    document.getElementById('restart-btn').onclick = () => {
        document.getElementById('death-screen').style.display = 'none';
        // æ ¸å¿ƒï¼šå¼ºåˆ¶é‡å¯¹é½æ—¶é—´è½´
        if (audioCtx) {
            audioCtx.resume().then(() => {
                nextBeatTime = audioCtx.currentTime + 0.05;
                gameReset();
                isPaused = false;
            });
        }
    };

    const ctrl = (x, y) => { if(!isPaused) { if(state.confusedCD>0){x=-x;y=-y;} if((x&&dx===0)||(y&&dy===0)){dx=x;dy=y;} } };
    document.getElementById('btn-up').onclick = () => ctrl(0,-1);
    document.getElementById('btn-down').onclick = () => ctrl(0,1);
    document.getElementById('btn-left').onclick = () => ctrl(-1,0);
    document.getElementById('btn-right').onclick = () => ctrl(1,0);
    const bBtn = document.getElementById('boost-btn');
    bBtn.ontouchstart = (e) => { e.preventDefault(); isBoosting = true; };
    bBtn.ontouchend = () => isBoosting = false;
    bBtn.onmousedown = () => isBoosting = true;
    bBtn.onmouseup = () => isBoosting = false;

    requestAnimationFrame(loop);
</script>
</body>
</html>